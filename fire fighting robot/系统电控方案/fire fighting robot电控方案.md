# 灭火机器人电控方案

电控方案主要包括：电机控制方案、 底层驱动方案、串口通信方案、系统框架等。

## 1. 系统框架

### 1） 主循环任务

- 10ms任务： 火焰传感器数据采集。
- 100ms任务：计算底盘两侧速度轮子，进行一次PID调节。

### 2） 中断任务

1. **编码器外部中断**，对脉冲进行计数，从而对底盘电机进行测速。
2. **超声波捕获中断**，
3. **串口IDLE中断**

## 2. 底层驱动方案

> 底层驱动方案包含：LED灯驱动、HC-SR04超声波驱动、底盘电机驱动、串口驱动、火焰传感器ADC驱动、风扇电机驱动、定时器驱动、编码器驱动

### 1） LED驱动

LED驱动为GPIO驱动，主要用来指示工作状态。主要的任务为LED灯状态切换（亮灭切换）。  
LED连接在PD.7上，为GPIO驱动，设置为推挽输出。PD.7输出高时LED灯亮，输出低时LED灯灭。

### 2） HC-SR04超声波驱动

灭火机器人包含三个HC-SR04超声波模块，分别探测距离前墙、左墙、右墙的值。  

1. **超声波接口**

    >前超声波  trig-->PC.11 echo-->PA.1 TIM2_CH2  
    >左超声波  trig-->PC.13 echo-->PA.2 TIM5_CH3  
    >右超声波  trig-->PC.12 echo-->PB.0 TIM3_CH3  

2. **测距传感器分析**

    市场上比较常用的测距模块有以下两种：  
    - **一种是激光测距**。这种模块的特点就是速度快、精确度高、测量距离远，但成本较高。
    - **另一种是超声波测距**。这种模块速度较慢、精确度受环境影响，而且测量距离小于5米，但不受被测量面的材质限制。

3. **如何控制超声波测量精度**

    - HC-SR04超声波测距原理见百度。
    - 声音在大气中的传播速度与温度和大气压力都有关系，所以在用超声波模块做高精度距离测量时，需要注意校准声速基准。

4. **数据读取的稳定性**

    - **超声波测距导致数据不稳的几个原因：**

        1.测量面密度较低，超声波穿透物体，会有多个回波；  
        2.测量面凹凸不平，超声波被打散，同样会有多个回波；  
        3.测量面倾斜，超声波没有正确反射；  
        4.测量面过小，超声波反射回的量不够。  
        所以用超声波较准确的读取距离值、识别边沿还是有比较多的难度。
    
### 3） 底盘电机驱动

底盘电机由两个连续旋转伺服电机组成，提供机器人移动所需的动力，使机器人能够实现前进，后退，转向。连续旋转舵机能正反两个方向连续旋转。

**基本参数**

- 运行速度：53R/M（4.8V）；62R/M（6V）。  

- 使用PWM波调制控制电机运动，PWM波频率为50Hz，高电平脉宽1.3ms正转，1.5ms停转，1.7ms反转。

**引脚信息**

- PD.12作为TIM4_CH1的外设引脚，输出PWM波控制右电机。
- PD.13作为TIM4_CH2的外设引脚，输出PWM波控制左电机。

### 4） 串口驱动

1. **Usart1**

    波特率115200，8数据位，1停止位，无校验位。用于与上位机进行通信。遥控器串口使能DMA接收、IDLE中断。使能DMA发送，需要发送数据时，只需打开DMA即可，节省了很多资源。

### 5） 火焰传感器驱动

通过ADC通道采集火焰传感器数据。

### 6） 风扇电机驱动

风扇电机由两部分组成：直流电机风扇模块、风扇转向舵机模块。

- **直流电机风扇模块**

  使用传感器开关。

- **风扇转向舵机模块**

  采用9g的辉盛舵机，更加轻盈。使用50Hz的PWM波调制，控制角度为-90°~90°。发现火源之后，控制舵机旋转45°，启动风扇，避免了整车旋转带来的时间与控制上的浪费。

### 7）定时器驱动

1. **计数**
    1. ~~产生5ms的中断执行任务。使用SysTick定时器，每隔5ms进入一次中断，在中断中执行任务调度。使用变量system_5ms记录系统进入中断的次数。~~

    2. 实际采用5ms进入中断执行任务调度是发现问题，会出现任务堵塞的情况。具体是在measure.c中的超声波测距的部分出现问题。



2. **产生PWM波**

### 8）编码器驱动

灭火机器人采用光电编码器测量底盘电机转速，作为PID调节的反馈值，码盘使用100线光栅码盘，提高测量精度。

轮子每转动一圈产生100个脉冲，采用外部中断的方式计数脉冲。当轮子的转速为60R/min时，10ms触发一次外部中断。100ms进行一次速度计算并输出速度与运动。  

## 3. 底盘控制方案

灭火机器人的底盘控制中，存在两个环。位置环PD，速度环PI。

1. 速度环PI：通过电机编码器对速度的编码，单片机解码获取当前电机的速度值，将当前速度输入速度PI环中，通过计算算出PWM赋值给电机，使得电机维持在我们的设定值。

2. 位置环PD：在速度环的基础上，单片机通过超声波检测灭火机器人前后两次距离墙的距离从而获取当前小车的倾斜情况，将角度送入直立环PD中计算，算出当前电机PWM，然后赋值给电机，从而保证小车的直行。

## 4. 系统中断任务及优先级

1. **系统所执行的中断任务有：**

    - Systick定时器5ms中断
    - TIM2，TIM3，TIM5更新与捕获中断
    - Usart1 IDLE中断

    并且，`delay_us()`与`delay_ms()`掩蔽所有中断，期间通过截取`Systick->VAL`的值来实现延时。

## 5. 出现的问题及分析

### 1） 任务调度周期

  在考虑任务调度周期的时候，之前的考虑为5ms,但是实际执行的时候会出现问题。采用5ms进入中断执行任务调度，会出现超声波无法测到距离的情况。具体是在measure.c中的超声波测距的部分出现问题。代码如下：

  ```c
  void Get_Distance_Front(void)
{
  u32 temp=0; 
  int16_t dis=0;
  printf("Sysinit is %d\t",SysTick->VAL);
  TIM_Cmd(TIM2,ENABLE);                    //使能定时器2
  GPIO_SetBits(GPIOC,GPIO_Pin_13);
  delay_us(20);
  GPIO_ResetBits(GPIOC,GPIO_Pin_13);

  while((!(TIM2CH2_CAPTURE_STA&0X80))&&(SysTick->VAL>4500));
  if(TIM2CH2_CAPTURE_STA&0X80)
  {
    temp+=TIM2CH2_CAPTURE_VAL;             //得到总的高电平时间
    dis=temp*170;
    dis /= 10;
    limitfilter(&dis);
    kalmanfilter(&dis);
    distance.front=dis;
    __Sensordata.dis_front=dis;
    printf("Syslast is %d\r\n",SysTick->VAL);
  }
  TIM_Cmd(TIM2,DISABLE);                   //失能定时器2
  TIM2CH2_CAPTURE_STA=0;                   //开启下一次捕获
}
  ```

- 其中，Systick定时器的reaload值为`fac_us*5000=9*5000=45000`,即5ms。

- `while((!(TIM2CH2_CAPTURE_STA&0X80))&&(SysTick->VAL>4500));`是等待超声波回波的语句，跳出循环的条件为超声波检测到回波或者距离下一个SysTick定时器异常的时间小于0.5ms时（即`SysTick->VAL>4500`），第二个判断条件时不希望因为检测不到回波而死在循环之中，进而堵塞任务调度。但是，这也**导致了超声波无法测到距离的情况出现。**

- 两个printf语句为调试语句，用于测量整个过程的时间。实际测量结果如下表所示：

  测量距离    |   20cm    |  30cm   | 40cm    |
  :----:     |:----:     | :----:  | :----:  |
  Sysinit    |44979     |  44979   |  44979  |
  Syslast    |15520     |  10745   |  5746   |

  其中`Systick->VAL`每减小9时，时间增加1us。由表中数据可以看出，距离每增加10cm，测量时间约增加`5000/9 us=0.56ms`,时间与通过距离/声速的计算值基本一致。
  
  表格中的数据增量符合计算，但是具体值（比如20cm时的测量时间）不符合`0.56ms/10cm`的计算，是因为printf语句占用了比较多的时间。如果去掉两句printf语句，通过Jlink硬件调试的方法来读取寄存器值，测量结果为：

  测量距离    |   20cm    |  30cm   | 40cm    |
  :----:     |:----:     | :----:  | :----:  |
  Sysinit    |44984     |  44982   |  44982  |
  Syslast    |29736     |  24067   |  18886  |